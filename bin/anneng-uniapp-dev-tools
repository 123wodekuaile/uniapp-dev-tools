#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * anneng-uniapp-dev-tools CLI
 */
function main() {
  const command = process.argv[2];
  
  switch (command) {
    case 'install':
      installDevTools();
      break;
    case 'gen-pages':
      generatePages();
      break;
    case 'copy-pages':
      copyPages();
      break;
    case 'config':
      showConfig();
      break;
    case 'init':
      initProject();
      break;
    default:
      showHelp();
  }
}

/**
 * å®Œæ•´å®‰è£…è°ƒè¯•å·¥å…·
 */
function installDevTools() {
  console.log('ğŸš€ å®‰è£… anneng-uniapp-dev-tools...');
  
  // åˆå§‹åŒ–é¡¹ç›®é…ç½®
  initProject();
  
  // å¤åˆ¶é¡µé¢æ–‡ä»¶
  copyPages();
  
  // ç”Ÿæˆé…ç½®
  generatePages();
  
  console.log('âœ… å®‰è£…å®Œæˆï¼');
  console.log('ğŸ“ è¯·åœ¨ä½ çš„é¡¹ç›®ä¸­å¼•å…¥è°ƒè¯•å·¥å…·ï¼š');
  console.log(`
import { devTools, devToolsConfig } from 'anneng-uniapp-dev-tools';
import Vue from 'vue';

Vue.use(devTools, {
  ...devToolsConfig,
  status: true
});
  `);
}

/**
 * åˆå§‹åŒ–é¡¹ç›®é…ç½®
 */
function initProject() {
  console.log('ğŸ“ åˆå§‹åŒ–é¡¹ç›®é…ç½®...');
  
  try {
    // åˆ›å»º gen-pages.js è„šæœ¬
    const scriptContent = fs.readFileSync(
      path.resolve(__dirname, '../scripts/gen-pages-template.js'),
      'utf8'
    );
    
    const scriptPath = path.resolve(process.cwd(), 'gen-pages.js');
    if (!fs.existsSync(scriptPath)) {
      fs.writeFileSync(scriptPath, scriptContent);
      console.log('âœ… å·²åˆ›å»º gen-pages.js è„šæœ¬');
    } else {
      console.log('âš ï¸  gen-pages.js å·²å­˜åœ¨ï¼Œè·³è¿‡');
    }
    
    // åˆ›å»º pages.base.json æ¨¡æ¿
    const baseConfigPath = path.resolve(process.cwd(), 'src/pages.base.json');
    if (!fs.existsSync(baseConfigPath)) {
      const baseConfigTemplate = {
        "pages": [
          {
            "path": "pages/index/index",
            "style": {
              "navigationBarTitleText": "é¦–é¡µ"
            }
          }
        ],
        "subPackages": [],
        "globalStyle": {
          "navigationBarTextStyle": "black",
          "navigationBarTitleText": "uni-app",
          "backgroundColor": "#F8F8F8"
        }
      };
      
      // ç¡®ä¿ src ç›®å½•å­˜åœ¨
      const srcDir = path.dirname(baseConfigPath);
      if (!fs.existsSync(srcDir)) {
        fs.mkdirSync(srcDir, { recursive: true });
      }
      
      fs.writeFileSync(baseConfigPath, JSON.stringify(baseConfigTemplate, null, 2));
      console.log('âœ… å·²åˆ›å»º src/pages.base.json æ¨¡æ¿');
    } else {
      console.log('âš ï¸  src/pages.base.json å·²å­˜åœ¨ï¼Œè·³è¿‡');
    }
    
  } catch (error) {
    console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error.message);
  }
}

/**
 * ç”Ÿæˆé¡µé¢é…ç½®
 */
function generatePages() {
  console.log('ğŸ”§ ç”Ÿæˆé¡µé¢é…ç½®...');
  
  try {
    const scriptPath = path.resolve(process.cwd(), 'gen-pages.js');
    if (fs.existsSync(scriptPath)) {
      // ä½¿ç”¨åŠ¨æ€importæ›¿ä»£require
      import(scriptPath).catch(error => {
        console.error('âŒ æ‰§è¡Œè„šæœ¬å¤±è´¥:', error.message);
      });
    } else {
      console.error('âŒ æœªæ‰¾åˆ° gen-pages.js è„šæœ¬ï¼Œè¯·å…ˆè¿è¡Œ init å‘½ä»¤');
    }
  } catch (error) {
    console.error('âŒ ç”Ÿæˆå¤±è´¥:', error.message);
  }
}

/**
 * å¤åˆ¶é¡µé¢æ–‡ä»¶
 */
function copyPages() {
  console.log('ğŸ“ å¤åˆ¶é¡µé¢æ–‡ä»¶...');
  
  try {
    const sourceDir = path.resolve(__dirname, '../page');
    const targetDir = path.resolve(process.cwd(), 'page');
    
    if (!fs.existsSync(sourceDir)) {
      console.error('âŒ æºç›®å½•ä¸å­˜åœ¨:', sourceDir);
      return;
    }
    
    if (!fs.existsSync(targetDir)) {
      fs.mkdirSync(targetDir, { recursive: true });
    }
    
    copyDirectory(sourceDir, targetDir);
    console.log('âœ… é¡µé¢æ–‡ä»¶å·²å¤åˆ¶åˆ°:', targetDir);
    
  } catch (error) {
    console.error('âŒ å¤åˆ¶å¤±è´¥:', error.message);
  }
}

/**
 * æ˜¾ç¤ºé…ç½®ä¿¡æ¯
 */
function showConfig() {
  console.log('ğŸ“‹ é¡µé¢é…ç½®ä¿¡æ¯:');
  console.log(`
{
  "subPackages": [
    {
      "root": "devTools/page",
      "name": "devToolsPage",
      "pages": [
        {
          "path": "index",
          "style": {
            "navigationStyle": "custom"
          }
        }
      ]
    }
  ]
}
  `);
  
  console.log('ğŸ“ ä½¿ç”¨è¯´æ˜:');
  console.log('1. åœ¨ src/pages.base.json ä¸­ç»´æŠ¤ä½ çš„é¡µé¢é…ç½®');
  console.log('2. è¿è¡Œ npm run gen-pages ç”Ÿæˆæœ€ç»ˆé…ç½®');
  console.log('3. åœ¨ package.json ä¸­æ·»åŠ è„šæœ¬:');
  console.log(`
  "scripts": {
    "gen-pages": "node gen-pages.js",
    "dev": "npm run gen-pages && uni-app dev",
    "build": "npm run gen-pages && uni-app build"
  }
  `);
}

/**
 * æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
 */
function showHelp() {
  console.log(`
anneng-uniapp-dev-tools CLI

ç”¨æ³•:
  anneng-uniapp-dev-tools <command>

å‘½ä»¤:
  install     å®Œæ•´å®‰è£…ï¼ˆåˆå§‹åŒ– + å¤åˆ¶é¡µé¢ + ç”Ÿæˆé…ç½®ï¼‰
  init        åˆå§‹åŒ–é¡¹ç›®é…ç½®ï¼ˆåˆ›å»ºè„šæœ¬å’Œæ¨¡æ¿ï¼‰
  gen-pages   ç”Ÿæˆé¡µé¢é…ç½®
  copy-pages  å¤åˆ¶é¡µé¢æ–‡ä»¶
  config      æ˜¾ç¤ºé…ç½®ä¿¡æ¯

ç¤ºä¾‹:
  npx anneng-uniapp-dev-tools install
  npx anneng-uniapp-dev-tools init
  npx anneng-uniapp-dev-tools gen-pages
  npx anneng-uniapp-dev-tools copy-pages
  npx anneng-uniapp-dev-tools config
  `);
}

/**
 * é€’å½’å¤åˆ¶ç›®å½•
 */
function copyDirectory(source, target) {
  const files = fs.readdirSync(source);
  
  files.forEach(file => {
    const sourcePath = path.join(source, file);
    const targetPath = path.join(target, file);
    const stat = fs.statSync(sourcePath);
    
    if (stat.isDirectory()) {
      if (!fs.existsSync(targetPath)) {
        fs.mkdirSync(targetPath, { recursive: true });
      }
      copyDirectory(sourcePath, targetPath);
    } else {
      fs.copyFileSync(sourcePath, targetPath);
    }
  });
}

// è¿è¡Œä¸»å‡½æ•°
main(); 